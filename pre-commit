#!/bin/sh

# pre-commit hook for Sketch files Git tracking

# Set UTF-8 encoding
export LANG=UTF-8
# Needed to work in SourceTree
export PATH=/usr/local/bin:$PATH

# Git repository absolute path
git_root=`git rev-parse --show-toplevel`
# Create array of all staged files
git_diff=`git diff --name-only --cached | grep ".*\.sketch$"`

# Check if there is any staged .sketch file
if [[ ${git_diff[0]} == '' ]]
then
    echo "No Sketch file staged."
else
  while read sketch_file
  do
    # Absolute Sketch file path
    sketch_file_path="$git_root/$sketch_file"
    # Unzipped directory
    unzipped_directory="$git_root/_unzipped/$sketch_file"
    # Untouched directory
    untouched_directory="$git_root/_untouched"
    # Untouched Sketch file
    untouched_path="$untouched_directory/$sketch_file"
    echo "$sketch_file"
    # Copy untouched Sketch file to untouched folder
    if mkdir -p "$untouched_path"
    then
      if cp "$sketch_file_path" "$untouched_path"
      then
        echo "Untouched '$sketch_file' backed up."
      else
        echo "Couldn't copy untouched '$sketch_file'."
        exit 1
      fi
    else
      echo "Couldn't create untouched directory."
      exit 1
    fi
    # Stage untouched file
    git add "$untouched_path"
    # Delete existing directory
    rm -rf "$unzipped_directory"
    # If Sketch file wasn't deleted
    if ! git diff --summary --cached -- $sketch_file | grep "delete" 2>&1 > /dev/null
    then
      # Create directory
      if mkdir -p "$unzipped_directory"
      then
        if cd "$unzipped_directory"
        then
          if unzip "$sketch_file_path"
          then
            echo "'$sketch_file' unzipped."
            for json_file in $(find . -name "*.json")
            do
              if python3 -m json.tool "$json_file" "$json_file".pretty
              then
                if mv "$json_file".pretty "$json_file"
                then
                  echo "'$json_file' prettified."
                else
                  echo "Couldn't move prettified '$json_file'."
                  rm -rf "$unzipped_directory"
                  exit 1
                fi
              else
                echo "Couldn't prettify '$json_file'."
                rm -rf "$unzipped_directory"
                exit 1
              fi
            done
          else
            echo "Couldn't unzip '$sketch_file'."
            rm -rf "$unzipped_directory"
            exit 1
          fi
          cd "$git_root"
        else
          echo "Couldn't change directory to '$unzipped_directory'."
          exit 1
        fi
      else
        echo "Couldn't create directory '$unzipped_directory'."
        exit 1
      fi
    fi
    git add "$unzipped_directory/*"
  done <<< "$git_diff"
fi
